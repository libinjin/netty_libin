package com.youguu.asteroid.invitation.service.impl;

import com.youguu.asteroid.invitation.dao.InviteAssistDAO;
import com.youguu.asteroid.invitation.dao.InviteShareDAO;
import com.youguu.asteroid.invitation.pojo.InvitAssistance;
import com.youguu.asteroid.invitation.pojo.InvitShared;
import com.youguu.asteroid.invitation.service.InviteAssistService;
import com.youguu.asteroid.windvane.mq.IMqSender;
import com.youguu.asteroid.windvane.pojo.MqSystemNotice;
import com.youguu.member.client.service.MemberRpcService;
import com.youguu.member.common.pojo.User;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import javax.annotation.Resource;
import java.util.Date;
import java.util.List;

@Service("inviteAssistService")
public class InviteAssistServiceImpl implements InviteAssistService {

    @Resource
    private InviteAssistDAO invit;
    @Resource
    private InviteShareDAO shareDAO;
    @Resource
    private IMqSender mqSender;
    @Resource
    private MemberRpcService asyncMemberRpcService;

    @Override
    public InvitAssistance queryAssistanceById(int id) {
        return invit.queryAssistanceById(id);
    }

    @Override
    public InvitAssistance queryAssistByUserId(int userId, int shareId) {
        return invit.queryAssistByUserId(userId,shareId);
    }

    @Override
    public List<InvitAssistance> queryAssisList(int shareId, int status) {
        return invit.queryAssisList(shareId,status);
    }

    @Override
    public int addAssistance(InvitAssistance invitAssistance) {
        int add = invit.addAssistance(invitAssistance);
        //在新增以后，推送一个消息
        if(add>0){
            int userId = invitAssistance.getUserId();
            String title = "优顾炒股";
            int [] us = new int[]{userId};
            String message = "您有一个15元现金红包未领取，<a href=\"http://m.youguu.com/mobile/redpackets/#/?join_channel=296\">前往领取》</a>";
            setMqMessage(title,us,2,message);
        }
        return add;
    }

    @Transactional("asteroidTX")
    @Override
    public int activeAssistance(int id, int status, int days, Date modifyTime, Date lastShareTime) {

        int update = invit.updateAssistance(id, status, days, modifyTime);
        if(update<=0){
            return update;
        }
        InvitAssistance invitAssistance = invit.queryAssistanceById(id);
        if(invitAssistance==null){
            return 0;
        }
        int shareId = invitAssistance.getShareId();
        int assistUserId = invitAssistance.getUserId();
        InvitShared invitShared = shareDAO.queryById(shareId);
        if(invitShared==null){
            return 0;
        }
        int num = invitShared.getNum() + 1;
        int shareDays = invitShared.getDays();
        int sharedUserId = invitShared.getUserId();
        int superId = invitShared.getSuperId();
        int sum = num >2 ? 14 : 7;
        invitShared.setStatus(1);
        invitShared.setDays(shareDays+sum);
        invitShared.setNum(num);
        invitShared.setModifyTime(new Date());
        shareDAO.UpdateByActive(status,modifyTime,lastShareTime,days,num,shareId);
        mqSender.sendAssitMsg(sharedUserId,superId,sum);
        String title = "优顾炒股";
        int [] us = new int[]{sharedUserId};
        User superUser = asyncMemberRpcService.getUser(superId);
        User assistUser = asyncMemberRpcService.getUser(assistUserId);
        String superNickName = superUser==null ? "" : superUser.getNickName();
        String assistNickName = assistUser==null ? "" : assistUser.getNickName();
        String message =  assistNickName+"已为您助力，您获得了追踪牛人"+superNickName+"的权限，<a href=\"youguu://homepage?uid="+superId+"\">点击去查看》</a>";
        setMqMessage(title,us,2,message);
        return update;
    }

    public boolean setMqMessage(String title,int[] us,int type,String message) {
        MqSystemNotice notice = new MqSystemNotice();
        notice.setTitle(title);
        notice.setToUids(us);
        notice.setType(type);
        notice.setMsg(message);
        notice.setCtime(new Date());
        return mqSender.sendSystemNotice(notice);
    }

    @Transactional("asteroidTX")
    @Override
    public int activeUser(int userId) {
        InvitAssistance invitAssistance = invit.findAssistListByUser(userId);
        if(invitAssistance!=null){
            int result = activeAssistance(invitAssistance.getId(),1,invitAssistance.getDays(),new Date(),new Date());
            return result;
        }
        return 0;
    }
}
feature_0211_asterlin